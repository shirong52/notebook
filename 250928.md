---


---

<h2 id="代码随想录">代码随想录</h2>
<h3 id="、二叉树的最近公共祖先">1、二叉树的最近公共祖先</h3>
<ul>
<li>从底往上遍历，但和实际二叉树遍历顺序不符，使用回溯</li>
<li>回溯要用后序遍历</li>
</ul>
<h3 id="、二叉搜索树的最近公共祖先">2、二叉搜索树的最近公共祖先</h3>
<ul>
<li>利用二叉搜索树的性质</li>
<li>遇到第一个节点满足大于p小于q的情况，它就是最优公共祖先，因为往左或往右都会错过其中任意一个</li>
<li>注意各个变量的类型</li>
</ul>
<h3 id="、二叉搜索树中的插入操作">3、二叉搜索树中的插入操作</h3>
<ul>
<li>在叶子节点插入即可</li>
<li>节点搜索到为空时，就是找到叶子节点了，可以插入了</li>
</ul>
<h2 id="实验">实验</h2>
<h3 id="nan修改建议">Nan修改建议</h3>
<ul>
<li>07：<a href="http://xn--model-xf6hm32aqr3dcowd4tf.py">问题出现在model.py</a>，MERU_with_Patches的forward开头，可能是曲率出现的问题使得出现梯度爆炸的问题</li>
</ul>
<blockquote>
<h2 id="曲率参数的初始化和处理">曲率参数的初始化和处理</h2>
<p>1.曲率参数的初始化 ：</p>
<ul>
<li>曲率参数 self.curv 实际上存储的是 曲率的对数值 （ log(curv_init) ）</li>
<li>真正的曲率值需要通过 self.curv.exp() 获取</li>
<li>注释中提到「Hyperboloid curvature will be -curv 」，表明实际的双曲曲率是 负的</li>
</ul>
<p>2.曲率参数的约束 ：</p>
<ul>
<li>为防止训练不稳定，代码对曲率的对数值设置了上下限</li>
<li>上限是 log(curv_init * 10) ，下限是 log(curv_init / 10)</li>
</ul>
<p>3.曲率参数的裁剪 ：</p>
<ul>
<li>在每次前向传播时，会对曲率的对数值进行裁剪，确保其在设定的范围内</li>
<li>然后通过 exp() 函数将对数值转换为实际的曲率值</li>
</ul>
<h2 id="可能导致曲率变为nan的原因">可能导致曲率变为NaN的原因</h2>
<p>1.梯度爆炸 ：</p>
<ul>
<li>如果在反向传播过程中， self.curv 的梯度变得非常大，可能导致参数更新后的值超出有效范围</li>
<li>虽然在前向传播时会进行裁剪，但如果梯度更新使得 self.curv.data 变为 NaN，裁剪操作也无法恢复</li>
</ul>
<p>2.数值不稳定性 ：</p>
<ul>
<li>在 exp_map0 函数中，如果输入的曲率值 curv 非常小（接近0），计算 rc_xnorm = curv**0.5 * torch.norm(x, dim=-1, keepdim=True) 可能导致数值不稳定</li>
<li>同样，如果曲率值非常大，也可能导致溢出</li>
</ul>
<p>3.优化器配置问题 ：</p>
<ul>
<li>如果学习率设置过高，可能导致曲率参数的更新过大，使其在一步更新后直接变为NaN</li>
</ul>
<h2 id="关于曲率是否为负数的问题">关于曲率是否为负数的问题</h2>
<p>1.代码设计中的曲率符号 ：</p>
<ul>
<li>代码注释明确指出：「Hyperboloid curvature will be -curv 」</li>
<li>这意味着实际的双曲曲率是 负的 ，而代码中的 curv 变量存储的是其 绝对值</li>
<li>在日志中看到的曲率值是正的，这是符合代码设计的，因为它表示的是曲率的绝对值</li>
</ul>
<p>2.代码中没有显式将曲率变为负数的操作 ：</p>
<ul>
<li>在 <a href="http://lorentz.py">lorentz.py</a> 中的函数实现中，曲率参数 curv 始终作为正值使用</li>
<li>例如在 exp_map0 函数中： rc_xnorm = curv**0.5 * torch.norm(x, dim=-1, keepdim=True)</li>
<li>这里使用了 curv**0.5 ，要求 curv 必须为正</li>
</ul>
<p>3.双曲几何中的曲率符号约定 ：</p>
<ul>
<li>在双曲几何中，曲率通常为负值</li>
<li>代码中通过将正值 curv 取负（隐式地，在实际计算中）来表示双曲曲率</li>
</ul>
</blockquote>
<h3 id="代码修改意见">代码修改意见</h3>
<pre class=" language-python"><code class="prism  language-python"><span class="token comment"># 1. 增强曲率参数的稳定性</span>
<span class="token comment"># 在forward方法中，在裁剪前检查曲率参数是否为NaN</span>
<span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> images<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> tokens<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 检查曲率参数是否为NaN，如果是则重置为初始值</span>
    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>self<span class="token punctuation">.</span>curv<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"警告：曲率参数为NaN，重置为初始值"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>curv<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 假设初始值为1.0</span>
        
    <span class="token comment"># 原有的裁剪逻辑</span>
    self<span class="token punctuation">.</span>curv<span class="token punctuation">.</span>data <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>self<span class="token punctuation">.</span>curv<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token operator">**</span>self<span class="token punctuation">.</span>_curv_minmax<span class="token punctuation">)</span>
    _curv <span class="token operator">=</span> self<span class="token punctuation">.</span>curv<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 2. 改进exp_map0函数中的数值稳定性</span>
<span class="token keyword">def</span> <span class="token function">exp_map0</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> curv<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">|</span> Tensor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span> eps<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""改进的exp_map0函数，增加数值稳定性"""</span>
    <span class="token comment"># 确保曲率为正值且不为零</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>curv<span class="token punctuation">,</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        curv <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>curv<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span>eps<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        curv <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>curv<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>
        
    <span class="token comment"># 计算范数，避免过大或过小的值</span>
    x_norm <span class="token operator">=</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 对x进行裁剪，防止过大的值导致数值不稳定</span>
    max_norm <span class="token operator">=</span> <span class="token number">1e3</span>  <span class="token comment"># 设置一个合理的上限</span>
    <span class="token keyword">if</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>x_norm<span class="token punctuation">)</span> <span class="token operator">&gt;</span> max_norm<span class="token punctuation">:</span>
        x <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span>max_norm <span class="token operator">/</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>x_norm<span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span>eps<span class="token punctuation">)</span><span class="token punctuation">)</span>
        x_norm <span class="token operator">=</span> torch<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    rc_xnorm <span class="token operator">=</span> curv<span class="token operator">**</span><span class="token number">0.5</span> <span class="token operator">*</span> x_norm
    
    <span class="token comment"># 使用更稳定的计算方式</span>
    <span class="token comment"># 当rc_xnorm很小时，sinh(rc_xnorm)/rc_xnorm ≈ 1 + rc_xnorm^2/6</span>
    mask <span class="token operator">=</span> rc_xnorm <span class="token operator">&lt;</span> eps
    scale <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>rc_xnorm<span class="token punctuation">)</span>
    
    <span class="token comment"># 对于非常小的值，使用泰勒展开近似</span>
    scale<span class="token punctuation">[</span>mask<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">+</span> rc_xnorm<span class="token punctuation">[</span>mask<span class="token punctuation">]</span><span class="token operator">**</span><span class="token number">2</span> <span class="token operator">/</span> <span class="token number">6.0</span>
    
    <span class="token comment"># 对于正常值，使用标准计算</span>
    sinh_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>rc_xnorm<span class="token punctuation">[</span><span class="token operator">~</span>mask<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span>eps<span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token operator">=</span>math<span class="token punctuation">.</span>asinh<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    scale<span class="token punctuation">[</span><span class="token operator">~</span>mask<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>sinh<span class="token punctuation">(</span>sinh_input<span class="token punctuation">)</span> <span class="token operator">/</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>rc_xnorm<span class="token punctuation">[</span><span class="token operator">~</span>mask<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token operator">=</span>eps<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> scale <span class="token operator">*</span> x

<span class="token comment"># 3. 添加梯度裁剪机制</span>
<span class="token comment"># 在优化器更新前添加梯度裁剪</span>
torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>clip_grad_norm_<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_norm<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>

<span class="token comment"># 或者专门为曲率参数设置更严格的梯度裁剪</span>
torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>clip_grad_norm_<span class="token punctuation">(</span><span class="token punctuation">[</span>model<span class="token punctuation">.</span>curv<span class="token punctuation">]</span><span class="token punctuation">,</span> max_norm<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>


<span class="token comment"># 4. 为曲率参数设置单独的学习率</span>
<span class="token comment"># 在优化器配置中为曲率参数设置较小的学习率</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string">'params'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> n<span class="token punctuation">,</span> p <span class="token keyword">in</span> model<span class="token punctuation">.</span>named_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> n <span class="token operator">!=</span> <span class="token string">'curv'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">'params'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>model<span class="token punctuation">.</span>curv<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> base_lr <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">}</span>  <span class="token comment"># 曲率参数使用更小的学习率</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>base_lr<span class="token punctuation">)</span>


<span class="token comment"># 5. 在exp_map0和log_map0函数中增加异常处理</span>
<span class="token keyword">def</span> <span class="token function">safe_exp_map0</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> curv<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">|</span> Tensor <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span> eps<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""带有异常处理的exp_map0函数"""</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> exp_map0<span class="token punctuation">(</span>x<span class="token punctuation">,</span> curv<span class="token punctuation">,</span> eps<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"exp_map0异常: {e}"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"输入x统计信息: min={x.min().item()}, max={x.max().item()}, "</span>
              f<span class="token string">"mean={x.mean().item()}, std={x.std().item()}, "</span>
              f<span class="token string">"has_nan={torch.isnan(x).any().item()}"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token string">"曲率值: {curv}"</span><span class="token punctuation">)</span>
        <span class="token comment"># 返回一个安全的替代值，例如原始输入</span>
        <span class="token keyword">return</span> x

</code></pre>
<p>目前07、06相关的代码调试操作已全部回退</p>
<h2 id="项目demo">项目Demo</h2>
<h3 id="图像分类微调（image-classification）">1. 图像分类微调（Image Classification）</h3>
<ul>
<li>
<p><strong>目标</strong>：在 CIFAR-10 / Food-101 等小数据集上微调 CLIP，用于分类任务</p>
</li>
<li>
<p><strong>推荐难度</strong>：⭐（非常适合入门）</p>
</li>
<li>
<p><strong>开源项目</strong>：</p>
<ul>
<li>
<p>HuggingFace 示例（官方文档）：<a href="https://huggingface.co/docs/transformers/tasks/image_classification">Fine-tune CLIP for image classification</a></p>
</li>
<li>
<p>OpenCLIP 仓库（训练 + 微调）：<a href="https://github.com/mlfoundations/open_clip">mlfoundations/open_clip</a></p>
</li>
</ul>
</li>
<li>
<p><strong>所需配置</strong>：</p>
<ul>
<li>
<p>1 张 RTX 3090 / 4090 即可</p>
</li>
<li>
<p>CIFAR-10 全训练只需几十分钟</p>
</li>
</ul>
</li>
</ul>
<p>👉 入门最佳选择，可以快速理解 <strong>如何冻结/解冻 CLIP 的 backbone</strong>。</p>
<hr>
<h3 id="图文检索微调（image-text-retrieval）">2. 图文检索微调（Image-Text Retrieval）</h3>
<ul>
<li>
<p><strong>目标</strong>：输入一张图片，找到最匹配的文本描述；或输入文本，找到最相关的图片</p>
</li>
<li>
<p><strong>推荐难度</strong>：⭐⭐（适合第二个项目）</p>
</li>
<li>
<p><strong>开源项目</strong>：</p>
<ul>
<li>
<p><a href="https://github.com/LAION-AI/CLIP_benchmark">clip-benchmark</a> （支持多个任务，包括检索）</p>
</li>
<li>
<p>HuggingFace CLIP 文档：<a href="https://huggingface.co/docs/transformers/model_doc/clip">CLIP model</a></p>
</li>
</ul>
</li>
<li>
<p><strong>数据集</strong>：Flickr30k（31k 图文对，轻量） / MSCOCO Captions</p>
</li>
<li>
<p><strong>所需配置</strong>：</p>
<ul>
<li>
<p>1–2 张 3090</p>
</li>
<li>
<p>训练时间：数小时到 1 天</p>
</li>
</ul>
</li>
</ul>
<p>👉 能深入理解 CLIP 的 <strong>对比学习损失（contrastive loss）</strong>。</p>
<hr>
<h3 id="prompt-tuning--adapter-tuning">3. Prompt Tuning / Adapter Tuning</h3>
<ul>
<li>
<p><strong>目标</strong>：不微调整个模型，只学习少量参数（prompt / adapter），在新任务上获得好效果</p>
</li>
<li>
<p><strong>推荐难度</strong>：⭐⭐（初学者可以尝试）</p>
</li>
<li>
<p><strong>开源项目</strong>：</p>
<ul>
<li>
<p>CoOp (Context Optimization)：<a href="https://github.com/KaiyangZhou/CoOp">KaiyangZhou/CoOp</a></p>
</li>
<li>
<p>HuggingFace PEFT（Parameter-Efficient Fine-Tuning）：<a href="https://huggingface.co/docs/peft/index">PEFT docs</a></p>
</li>
</ul>
</li>
<li>
<p><strong>所需配置</strong>：</p>
<ul>
<li>
<p>单张 3090 就能跑</p>
</li>
<li>
<p>训练速度比全模型快得多</p>
</li>
</ul>
</li>
</ul>
<p>👉 可以体验最前沿的 <strong>参数高效微调方法</strong>，适合科研入门。</p>
<hr>
<h3 id="跨模态搜索引擎-demo">4. 跨模态搜索引擎 Demo</h3>
<ul>
<li>
<p><strong>目标</strong>：搭建一个“输入一句话，检索最相似的图片”的系统</p>
</li>
<li>
<p><strong>推荐难度</strong>：⭐（应用型项目，趣味高）</p>
</li>
<li>
<p><strong>开源项目</strong>：</p>
<ul>
<li>
<p>使用 FAISS + CLIP 的搜索例子：<a href="https://github.com/rom1504/clip-faiss">clip-faiss</a></p>
</li>
<li>
<p>也可用 HuggingFace + FAISS 自己写 demo</p>
</li>
</ul>
</li>
<li>
<p><strong>数据</strong>：可以用 Unsplash API 或自己收集的小图像库</p>
</li>
<li>
<p><strong>所需配置</strong>：</p>
<ul>
<li>
<p>一张消费级 GPU 即可</p>
</li>
<li>
<p>数据规模小的话，CPU 也能跑</p>
</li>
</ul>
</li>
</ul>
<p>👉 非常适合展示成果（可做小 demo，像迷你版“图文搜索引擎”）。</p>
<hr>
<h3 id="视觉问答-vqa-入门">5. 视觉问答 (VQA) 入门</h3>
<ul>
<li>
<p><strong>目标</strong>：用 CLIP 提取图像特征，结合一个小型语言模型回答自然语言问题</p>
</li>
<li>
<p><strong>推荐难度</strong>：⭐⭐⭐（需要跨模态整合，稍复杂）</p>
</li>
<li>
<p><strong>开源项目</strong>：</p>
<ul>
<li>
<p><a href="https://huggingface.co/datasets/visual_genome">HuggingFace VQA example</a>（配合 CLIP 使用）</p>
</li>
<li>
<p>MiniVQA 项目示例：<a href="https://github.com/BCV-Uniandes/clip-vqa">clip-vqa</a></p>
</li>
</ul>
</li>
<li>
<p><strong>数据集</strong>：VQAv2 / Visual Genome</p>
</li>
<li>
<p><strong>所需配置</strong>：</p>
<ul>
<li>
<p>至少 1 张 3090</p>
</li>
<li>
<p>数据大时建议多卡</p>
</li>
</ul>
</li>
</ul>
<p>👉 学会 <strong>图像特征 + 文本特征融合</strong>，往多模态 LLM 应用迈进一步。</p>
<hr>
<h3 id="📌-推荐学习顺序">📌 推荐学习顺序</h3>
<ol>
<li>
<p><strong>图像分类微调</strong> → 入门</p>
</li>
<li>
<p><strong>图文检索微调</strong> → 了解 contrastive learning</p>
</li>
<li>
<p><strong>Prompt/Adapter Tuning</strong> → 体验轻量微调</p>
</li>
<li>
<p><strong>跨模态搜索引擎</strong> → 做一个可展示 demo</p>
</li>
<li>
<p><strong>视觉问答</strong> → 多模态应用进阶</p>
</li>
</ol>

