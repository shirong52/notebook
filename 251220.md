---


---

<h2 id="量化简介">量化简介</h2>
<blockquote>
<p><a href="https://mlabonne.github.io/blog/posts/Introduction_to_Weight_Quantization.html">权重量化简介 – Maxime Labonne — Introduction to Weight Quantization – Maxime Labonne</a></p>
</blockquote>
<h3 id="分类">分类</h3>
<ul>
<li>训练后量化PTQ：将已训练模型的权重转化为较低的精度，无需重新训练；但可能导致性能下降</li>
<li>量化感知训练QAT：在预训练或微调阶段结合权重转换，增强模型性能；但计算成本高，且需要具有代表性的训练数据</li>
</ul>
<h3 id="浮点表示">浮点表示</h3>
<p><strong>三个组件</strong></p>
<ul>
<li>sign：符号位表示数字的正负性质。它使用一位，其中 0 表示正数，1 表示负数。</li>
<li>exponent：指数是一段bit，表示基数（通常为二进制表示法为 2）的幂。指数也可以是正数或负数，允许数字表示非常大或非常小的值。</li>
<li>significand：剩余的位用于存储有效数，也称为尾数。这表示数字的有效位数。数字的精度在很大程度上取决于有效数的长度。<br>
<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mtext>sign</mtext></msup><mo>×</mo><msup><mtext>base</mtext><mtext>exponent</mtext></msup><mo>×</mo><mtext>significand</mtext></mrow><annotation encoding="application/x-tex">(-1)^{\text{sign}} \times \text{base}^{\text{exponent}} \times \text{significand}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.1305em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.880502em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">sign</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.961226em; vertical-align: -0.08333em;"></span><span class="mord"><span class="mord text"><span class="mord">base</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.877896em;"><span class="" style="top: -3.14734em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">exponent</span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord text"><span class="mord">significand</span></span></span></span></span></span></span></li>
</ul>
<p><strong>常用数据类型</strong></p>
<ul>
<li><strong>FP32</strong><br>
使用 32 位来表示一个数字：1位表示符号，8 位表示指数，其余 23 位表示有效数。虽然它提供了高精度，但 FP32 的缺点是其高计算和内存占用。</li>
<li><strong>FP16</strong><br>
使用 16 位来存储一个数字：1个用于符号，5个用于指数，10个用于有效位。尽管这使得它的内存效率更高并加速了计算，但范围和精度的降低可能会带来数值不稳定性，从而可能影响模型的准确性。</li>
<li><strong>BF16</strong><br>
也是一种 16 位格式，但有1位表示符号，8位表示指数，7位表示有效位。与 FP16 相比，BF16 扩大了可表示范围，从而降低了底溢和溢出风险。尽管由于有效位数减少而降低了精度，但 BF16 通常不会显着影响模型性能，并且是深度学习任务的有用折衷方案。<br>
。。。</li>
</ul>
<h2 id="gptq">GPTQ</h2>
<blockquote>
<p><a href="https://mlabonne.github.io/blog/posts/4_bit_Quantization_with_GPTQ.html">使用 GPTQ 进行 4 位 LLM 量化 – Maxime Labonne — 4-bit LLM Quantization with GPTQ – Maxime Labonne</a></p>
</blockquote>
<h3 id="最佳大脑量化obq">最佳大脑量化OBQ</h3>
<p><strong>问题</strong><br>
对每一层<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathnormal" style="margin-right: 0.01968em;">l</span></span></span></span></span>的原始权重<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi mathvariant="normal">ℓ</mi></msub></mrow><annotation encoding="application/x-tex">W_{\ell}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>都想找到量化版本<br>
<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>arg</mi><mo>⁡</mo><munder><mrow><mi>min</mi><mo>⁡</mo></mrow><msub><mi>W</mi><mi mathvariant="normal">ℓ</mi></msub></munder><msubsup><mrow><mo fence="true">∥</mo><msub><mi>W</mi><mi mathvariant="normal">ℓ</mi></msub><msub><mi>X</mi><mi mathvariant="normal">ℓ</mi></msub><mo>−</mo><msub><mi>W</mi><mi mathvariant="normal">ℓ</mi></msub><msub><mi>X</mi><mi mathvariant="normal">ℓ</mi></msub><mo fence="true">∥</mo></mrow><mn>2</mn><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">
\arg \min _{W_{\ell}}\left\|W_{\ell} X_{\ell}-W_{\ell} X_{\ell}\right\|_{2}^{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.8042em; vertical-align: -0.850191em;"></span><span class="mop">ar<span style="margin-right: 0.01389em;">g</span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.66786em;"><span class="" style="top: -2.35567em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.34877em; margin-left: -0.13889em; margin-right: 0.0714286em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.151229em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop">min</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.850191em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;">∥</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.07847em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;">∥</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.954008em;"><span class="" style="top: -2.4003em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2997em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>GPTQ算法</strong></p>
<ol>
<li>任意顺序进行量化权重参数的选择，GPTQ 旨在对矩阵中所有行的所有权重按相同顺序量化。</li>
<li>延迟更新，GPTQ 一次对一个batch（比如 128 列）应用算法，只更新这些列和矩阵中的相应区块。在一个块完全处理完毕后，算法会对整个矩阵进行全局更新。</li>
<li>当算法扩展到非常大的模型时，数值不准确性可能会成为问题，重复进行某一操作可能会累积数值误差。GPTQ 采用了 Cholesky 分解，预先计算矩阵中所需的部分信息。这种方法结合轻微的“阻尼”（在矩阵的对角线元素中增加一个小常数），有助于算法避免数值问题。</li>
</ol>
<p><strong>参数</strong></p>
<ul>
<li>bits：量化的位数</li>
<li>group_size：batch大小</li>
<li>damp_percent：为了帮助Cholesky reformulation，不应被更改</li>
<li>desc_act：允许根据激活度递减来处理行，即最重要或影响最大的行（由采样输入和输出决定）会先处理，将大部分量化误差（在量化过程中不可避免地引入）放在较不重要的权重上；但当与group_size结合使用时， desc_act 由于需要频繁重新加载量化参数，可能导致性能变慢</li>
</ul>

